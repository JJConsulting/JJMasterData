@using JJConsulting.FontAwesome
@using JJMasterData.Core.DataDictionary.Models.Actions
@inject IStringLocalizer<MasterDataResources> StringLocalizer

@model ActionListModel

@{
    ViewData["Title"] = $"{Model.ElementName} - {StringLocalizer["Actions"]}";
    Layout = "_FormElementMenuLayout";
    ViewData["ElementName"] = Model.ElementName;
    ViewData["MenuId"] = "Actions";

    ActionSource selectedSource = Model.Source;
}

@if (ViewData["ShowSaveSuccess"] is true)
{
    <message-toast
        title-color="Success"
        title="@StringLocalizer["Success"]"
        icon="@FontAwesomeIcon.CheckCircle"
        name="action-save-success"
        show-as-opened="false"
        message="@StringLocalizer["Action saved successfully."]"/>
    <script>
                MessageToastHelper.show("action-save-success");
            </script>
}

@if (ViewData["ShowCopySuccess"] is true)
{
    <message-toast
        title-color="Success"
        title="@StringLocalizer["Success"]"
        icon="@FontAwesomeIcon.CheckCircle"
        name="action-copy-success"
        show-as-opened="false"
        message="@StringLocalizer["Action copied successfully."]"/>
    <script>
                MessageToastHelper.show("action-copy-success");
            </script>
}

<ul class="nav nav-underline">
    <li id="navGrid" class="nav-item">
        <a class="nav-link @(selectedSource == ActionSource.GridTable ? "active" : string.Empty)"
           href="@Url.Action("Index", "Actions", new { elementName = Model.ElementName, source = ActionSource.GridTable })">@StringLocalizer["Grid Table"]</a>
    </li>
    <li id="navGridToolbar" class="nav-item">
        <a class="nav-link @(selectedSource == ActionSource.GridToolbar ? "active" : string.Empty)"
           href="@Url.Action("Index", "Actions", new { elementName = Model.ElementName, source = ActionSource.GridToolbar })">@StringLocalizer["Grid Toolbar"]</a>
    </li>
    <li id="navFormFields" class="nav-item">
        <a class="nav-link @(selectedSource == ActionSource.Field ? "active" : string.Empty)"
           href="@Url.Action("Index", "Actions", new { elementName = Model.ElementName, source = ActionSource.Field })">@StringLocalizer["Form Fields"]</a>
    </li>
    <li id="navFormToolbar" class="nav-item">
        <a class="nav-link @(selectedSource == ActionSource.FormToolbar ? "active" : string.Empty)"
           href="@Url.Action("Index", "Actions", new { elementName = Model.ElementName, source = ActionSource.FormToolbar })">@StringLocalizer["Form Toolbar"]</a>
    </li>
</ul>

<div class="mt-3">
    <partial name="_ActionListTab" model="Model"/>
</div>

<div class="modal fade" id="actionDetailsModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-fullscreen modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">@StringLocalizer["Actions"]</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="action-details-modal-host"></div>
        </div>
    </div>
</div>

<script type="text/javascript">
    const actionDetailsModalId = "actionDetailsModal";
    const actionDetailsModalHostId = "action-details-modal-host";

    function isActionDetailsMobile() {
        return window.matchMedia("(max-width: 575.98px)").matches;
    }

    function ensureActionDetailsModal(source) {
        const modalEl = document.getElementById(actionDetailsModalId);
        if (!modalEl || !window.bootstrap || !bootstrap.Modal) {
            return null;
        }

        modalEl.setAttribute("data-action-source", source);
        if (!modalEl.dataset.listenerAttached) {
            modalEl.addEventListener("hidden.bs.modal", function () {
                const currentSource = modalEl.getAttribute("data-action-source");
                if (currentSource) {
                    restoreActionDetailsFromModal(currentSource);
                }
            });
            modalEl.dataset.listenerAttached = "true";
        }

        return modalEl;
    }

    function moveActionDetailsToModal(detailsId, source) {
        const details = document.getElementById(detailsId);
        const modalHost = document.getElementById(actionDetailsModalHostId);
        const detailsHost = document.getElementById("action-details-host-" + source);
        if (!details || !modalHost || !detailsHost) {
            return;
        }

        modalHost.appendChild(details);
    }

    function restoreActionDetailsFromModal(source) {
        const modalHost = document.getElementById(actionDetailsModalHostId);
        const detailsHost = document.getElementById("action-details-host-" + source);
        const details = modalHost?.querySelector("#action-details-" + source);
        if (!details || !detailsHost) {
            return;
        }

        detailsHost.appendChild(details);
    }

    async function loadActionDetails(url, actionKey, source) {
        const key = actionKey || "";
        const safeKey = key.replace(/[^\w-]/g, "\\$&");
        const listSelector = "#sortable-" + source;
        const detailsId = "action-details-" + source;

        document.querySelector(listSelector + " .active")?.classList?.remove("active");
        if (safeKey) {
            document.querySelector(listSelector + " #" + safeKey)?.classList?.add("active");
        }

        if (isActionDetailsMobile()) {
            const modalEl = ensureActionDetailsModal(source);
            moveActionDetailsToModal(detailsId, source);
            if (modalEl) {
                bootstrap.Modal.getOrCreateInstance(modalEl).show();
            }
        }

        SpinnerOverlay.show();
        try {
            const response = await fetch(url, { headers: { "X-Requested-With": "XMLHttpRequest" } });
            const html = await response.text();
            HTMLHelper.setInnerHTML(detailsId, html);
            document.getElementById(detailsId)?.setAttribute("data-loaded", "true");
            listenAllEvents("#" + detailsId);
        } finally {
            SpinnerOverlay.hide();
        }
    }

    function searchActions(source, input) {
        const value = (input.value || "").toLowerCase();
        const listSelector = "#sortable-" + source;
        $(listSelector + " a").filter(function () {
            const textValues = $(this).clone().find(".bootstrap-select, .selectpicker, select").remove().end().text();
            $(this).toggle(textValues.toLowerCase().indexOf(value) > -1);
        });
    }
</script>

@if (!ViewData.ModelState.IsValid && Model.SelectedAction is not null)
{
    <script type="text/javascript">
        document.addEventListener("DOMContentLoaded", function () {
            if (!isActionDetailsMobile()) {
                return;
            }
            const source = "@Model.Source";
            const detailsId = "action-details-" + source;
            const modalEl = ensureActionDetailsModal(source);
            moveActionDetailsToModal(detailsId, source);
            if (modalEl && window.bootstrap && bootstrap.Modal) {
                bootstrap.Modal.getOrCreateInstance(modalEl).show();
            }
        });
    </script>
}
