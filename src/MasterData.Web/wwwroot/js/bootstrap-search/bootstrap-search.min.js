const DEFAULTS={threshold:2,maximumItems:5,highlightTyped:!0,highlightClass:"text-primary",inputLabel:"label",dropdownLabel:"label",value:"value",showValue:!1,showValueBeforeLabel:!1,remoteData:null,resolveData:t=>t,onInput:null,onSelectItem:null,multiSelect:!1,dropdownClass:""};class BootstrapSearch{constructor(t,e){this.field=t,this.options=Object.assign({},DEFAULTS,e),this.dropdown=null,this.controller=null,this.activeIndex=-1,this.selectedItems=[],this._updatingValue=!1,t.classList.add("bootstrap-search-field","form-control");const s=document.createElement("div");s.className="position-relative",t.parentNode.insertBefore(s,t),s.appendChild(t),this.statusIcon=document.createElement("span"),this.statusIcon.className="position-absolute top-50 end-0 translate-middle-y pe-2",s.appendChild(this.statusIcon),this.selectedItems.length>0||this.field.value?this.showSuccess():this.setDefaultIcon();const i=document.createElement("div");i.className="dropdown-menu w-100",i.style.maxHeight="250px",i.style.overflowY="auto",this.options.dropdownClass&&i.classList.add(this.options.dropdownClass),s.appendChild(i),this.dropdownDiv=i,this.dropdown=new bootstrap.Dropdown(t,{autoClose:!this.options.multiSelect}),this.field.addEventListener("input",(()=>{if(!this._updatingValue){if(this.activeIndex=-1,this.options.multiSelect){const t=this.field.value.split(",").map((t=>t.trim()));this.selectedItems=this.selectedItems.filter((e=>t.includes(e.label))),this.options.onSelectItem&&this.options.onSelectItem([...this.selectedItems]),this.options.onSelectItem&&this.options.onSelectItem([])}else this.selectedItems=[],this.options.onSelectItem&&this.options.onSelectItem(null);this.clearStatus(),this.setDefaultIcon(),this.dropdownDiv.querySelectorAll(".dropdown-item i.fas.fa-check").forEach((t=>t.remove())),this.options.onInput&&this.options.onInput(this.field.value),this.options.remoteData?(this.field.value.length>=this.options.threshold&&this.showLoading(),this.fetchData(this.field.value).then((t=>this.renderIfNeeded()))):this.renderIfNeeded()}})),t.addEventListener("keydown",(t=>this.handleKeydown(t))),document.addEventListener("click",(t=>{this.dropdownDiv.contains(t.target)||t.target===this.field||this.dropdown.hide()})),t.addEventListener("focus",(()=>{this.selectedItems.length&&(this.renderIfNeeded(),this.dropdown.show())})),t.bootstrapSearch=this}clear(){this.selectedItems=[],this.field.value="",this.setDefaultIcon(),this.dropdown.hide()}handleKeydown(t){const e=Array.from(this.dropdownDiv.querySelectorAll(".dropdown-item"));e.length&&("ArrowDown"===t.key?(t.preventDefault(),this.activeIndex=(this.activeIndex+1)%e.length,this.updateActive(e)):"ArrowUp"===t.key?(t.preventDefault(),this.activeIndex=(this.activeIndex-1+e.length)%e.length,this.updateActive(e)):"Enter"===t.key?(t.preventDefault(),this.activeIndex>=0&&e[this.activeIndex]&&e[this.activeIndex].click()):"Escape"===t.key&&this.dropdown.hide())}updateActive(t){t.forEach(((t,e)=>{e===this.activeIndex?(t.classList.add("active"),t.scrollIntoView({block:"nearest"})):t.classList.remove("active")}))}setDefaultIcon(){this.statusIcon.innerHTML='<i class="fas fa-search text-secondary"></i>'}showLoading(){this.statusIcon.innerHTML='<div class="spinner-border spinner-border-sm text-secondary" role="status"><span class="visually-hidden">Loading...</span></div>'}showSuccess(){this.statusIcon.innerHTML='<i class="fas fa-check text-success"></i>'}showNoResults(){this.statusIcon.innerHTML='<i class="fas fa-times text-secondary"></i>'}showError(){this.statusIcon.innerHTML='<i class="fas fa-times text-danger"></i>'}clearStatus(){this.statusIcon.innerHTML=""}async fetchData(t){if(this.options.multiSelect){const e=t.split(",");t=e[e.length-1].trim()}if(t.length<this.options.threshold)return this.clearStatus(),void this.setDefaultIcon();this.controller&&this.controller.abort(),this.controller=new AbortController;try{const e="function"==typeof this.options.remoteData?this.options.remoteData(encodeURIComponent(t)):this.options.remoteData,s=await fetch(e,{signal:this.controller.signal}),i=await s.json();this.setData(this.options.resolveData(i))}catch(t){"AbortError"!==t.name&&(console.error(t),this.showError())}finally{this.selectedItems.length||this.setDefaultIcon()}}setData(t){this.options.data=t,this.renderIfNeeded()}renderIfNeeded(){this.createItems()>0?(this.dropdown.show(),this.setDefaultIcon()):(this.dropdown.hide(),this.showNoResults())}createItem(t,e){function s(t){return String(t).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}let i;const o="function"==typeof this.options.dropdownLabel?this.options.dropdownLabel(e):s("string"==typeof this.options.dropdownLabel?e[this.options.dropdownLabel]??"":e.label??"");if(this.options.highlightTyped&&t){const e=removeDiacritics(o).toLowerCase(),n=removeDiacritics(t).toLowerCase(),a=e.indexOf(n),l=Array.isArray(this.options.highlightClass)?this.options.highlightClass.join(" "):this.options.highlightClass;i=a>=0&&"function"!=typeof this.options.dropdownLabel?o.substring(0,a)+`<span class="${s(l)}">${s(o.substring(a,a+t.length))}</span>`+s(o.substring(a+t.length)):o}else i=o;if("function"!=typeof this.options.dropdownLabel&&(i=`<div>${i}</div>`),this.options.showValue){const t=s("function"==typeof this.options.value?this.options.value(e):"string"==typeof this.options.value?e[this.options.value]??"":e.value??"");i=this.options.showValueBeforeLabel?`${t} ${i}`:`${i} ${t}`}const n="function"==typeof this.options.value?this.options.value(e):"string"==typeof this.options.value?e[this.options.value]??"":e.value??"",a=document.createElement("button");return a.type="button",a.className="dropdown-item d-flex justify-content-between align-items-center",a.setAttribute("data-label",s("function"==typeof this.options.inputLabel?this.options.inputLabel(e):e[this.options.inputLabel]??"")),a.setAttribute("data-value",n),a.innerHTML=i,this.selectedItems.find((t=>t.value==n))&&(a.innerHTML+=' <i class="fas fa-check fa-lg text-success"></i>'),a}createItems(){const t=this.dropdownDiv;if(t.innerHTML="",!this.options.data)return 0;const e=Array.isArray(this.options.data)?this.options.data:Object.values(this.options.data);let s=0;for(let i of e)if(this.options.multiSelect)t.appendChild(this.createItem(null,i));else{const e=this.field.value;if(removeDiacritics("function"==typeof this.options.dropdownLabel?this.options.dropdownLabel(i):"string"==typeof this.options.dropdownLabel?i[this.options.dropdownLabel]??"":i.label??"").toLowerCase().includes(removeDiacritics(e).toLowerCase())&&(t.appendChild(this.createItem(e,i)),this.options.maximumItems>0&&++s>=this.options.maximumItems))break}const i=t.querySelectorAll(".dropdown-item");return i.forEach((t=>{t.addEventListener("click",(t=>{t.stopPropagation();const e=t.currentTarget.getAttribute("data-label"),s=t.currentTarget.getAttribute("data-value");if(this.options.multiSelect){this.selectedItems.find((t=>t.value==s))?this.selectedItems=this.selectedItems.filter((t=>t.value!=s)):this.selectedItems.push({value:s,label:e}),this._updatingValue=!0,this.field.value=this.selectedItems.map((t=>t.label)).join(", "),this._updatingValue=!1,this.renderIfNeeded(),this.selectedItems.length?this.showSuccess():this.setDefaultIcon(),this.options.onSelectItem&&this.options.onSelectItem([...this.selectedItems])}else this.selectedItems=[{value:s,label:e}],this.field.value=e,this.dropdown.hide(),this.showSuccess(),this.options.onSelectItem&&this.options.onSelectItem(this.selectedItems[0])}))})),i.length>0?this.dropdown.show():this.dropdown.hide(),i.length}}function removeDiacritics(t){return t?.normalize("NFD").replace(/[\u0300-\u036f]/g,"")}