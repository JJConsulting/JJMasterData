@using JJMasterData.Commons.Data.Entity
@using JJMasterData.Core.Web
@inject IStringLocalizer<JJMasterDataResources> StringLocalizer
@inject IOptions<JJMasterDataWebOptions> Options
@model JJMasterData.Core.DataDictionary.Models.Actions.InternalAction

@{
    Layout = Options.Value.PopUpLayoutPath;
}

<script type="text/javascript">
    $(document).ready(function() {
        savePanelState();
    });


    function savePanelState() {
        var currentTab = $("#selected-tab").val();
        if (!currentTab) {
            currentTab = "#div-general";
        }
        $(".nav a[href='" + currentTab + "']").tab("show");

        $("a[@BootstrapHelper.DataToggle='tab']").on("shown.bs.tab", function(e) {
            var target = $(e.target).attr("href");
            $("#selected-tab").val(target);
            resizeContainer();
        });
    }


    function addRelation() {
        SpinnerOverlay.show();
        var url = "@Html.Raw(Url.Action("AddRelation", "Actions", new { elementName = ViewBag.ElementName, context = ViewBag.ContextAction, fieldName = ViewBag.FieldName }))";
        $("form:first").attr("action", url).submit();
    }

    function removeRelation(relationIndex) {
        SpinnerOverlay.show();
        $("<input>").attr({
            type: "hidden",
            id: "relationIndex",
            name: "relationIndex",
            value: relationIndex
        }).appendTo("form");

        var url = "@Url.Action("RemoveRelation", "Actions", new { elementName = ViewBag.ElementName, context = ViewBag.ContextAction, fieldName = ViewBag.FieldName })";
        $("form:first").attr("action", url).submit();
    }


</script>

@using (Html.BeginForm("InternalAction", "Actions",
   new { elementName = ViewBag.ElementName, context = ViewBag.ContextAction, fieldName = ViewBag.FieldName }, FormMethod.Post))
{
    <input type="hidden" name="selected-tab" id="selected-tab" value="@ViewBag.Tab" />

    <ul class="nav nav-tabs">
        <li id="nav-general" class="nav-item active"><a class="nav-link active" @BootstrapHelper.GetDataToggle("tab") href="#div-general">@StringLocalizer["General"]</a></li>
        <li id="navInternalRedirect" class="nav-item"><a class="nav-link" @BootstrapHelper.GetDataToggle("tab") href="#divInternalredirect">@StringLocalizer["Internal Redirect"]</a></li>
        <li id="nav-advanced" class="nav-item"><a class="nav-link" @BootstrapHelper.GetDataToggle("tab") href="#div-advanced">@StringLocalizer["Advanced"]</a></li>
    </ul>

    <div class="tab-content" style="margin-top: 20px;">
        <div id="div-general" class="tab-pane fade active @BootstrapHelper.Show">
            @await Html.PartialAsync("_NavGeneral", Model)
        </div>

        <div id="divInternalredirect" class="tab-pane fade">
            <div class="row">

                <div class="@BootstrapHelper.FormGroup col-sm-4 required">
                    <label class="@BootstrapHelper.Label" @BootstrapHelper.GetDataToggle("tooltip") title="@StringLocalizer["Dictionary name"]">@StringLocalizer["Entity Name"]</label>
                    @if (Model.ElementRedirect.RelationFields.Count == 0)
                    {
                        @Html.DropDownListFor(model => model.ElementRedirect.ElementNameRedirect,
                            new SelectList(ViewBag.ElementNameList, "Key", "Value"),
                            new { @class = "form-control form-select", onchange = "this.form.requestSubmit();" })
                    }
                    else
                    {
                        @Html.TextBoxFor(model => model.ElementRedirect.ElementNameRedirect, new { @class = "form-control", @readonly = "@readonly" })
                    }
                </div>

                <div class="@BootstrapHelper.FormGroup col-sm-4 required">
                    <label class="@BootstrapHelper.Label">@StringLocalizer["ViewType"]</label>
                    <select asp-for="ElementRedirect.ViewType" class="form-control form-select" asp-items="Html.GetEnumSelectList<RelationshipViewType>()"></select>
                </div>

                <div class="@BootstrapHelper.FormGroup col-sm-4">
                    <label class="@BootstrapHelper.Label " for="cboPopUpSize" @BootstrapHelper.GetDataToggle("tooltip") title="@StringLocalizer["Popup Size"]">@StringLocalizer["Popup Size"]</label>
                     <select asp-for="ElementRedirect.ModalSize" class="form-control" asp-items="Html.GetEnumSelectList<ModalSize>()"></select>
                </div>

            </div>
            <div class="row">
                <div class="col-sm-12">
                    <h4>@StringLocalizer["Relation"]</h4>
                    <hr />
                </div>
            </div>
            <div class="row">
                <div class="@BootstrapHelper.FormGroup col-sm-4 required">
                    <label class="@BootstrapHelper.Label" @BootstrapHelper.GetDataToggle("tooltip") title="@StringLocalizer["Field"]">@StringLocalizer["Field"]</label>
                    @Html.DropDownList("redirectField", new SelectList(ViewBag.RedirectFieldList, "Key", "Value"), new { @class = "form-control" })
                </div>
                <div class="@BootstrapHelper.FormGroup col-sm-5 required">
                    <label class="@BootstrapHelper.Label" @BootstrapHelper.GetDataToggle("tooltip") title="@StringLocalizer["Field"]">@StringLocalizer["Value"]</label>
                    @Html.DropDownList("internalField", new SelectList(ViewBag.InternalFieldList, "Key", "Value"), new { @class = "form-control" })
                </div>
            </div>

            <div class="row">
                <div class="col-sm-4">
                    <button type="button" class="@BootstrapHelper.DefaultButton" @BootstrapHelper.GetDataToggle("tooltip") title="@StringLocalizer["Add Reference"]" OnClick="addRelation();">
                        <span class="fa fa-plus-square-o"></span>&nbsp;@StringLocalizer["Add"]
                    </button>
                </div>
            </div>

            <div class="row">
                <div class="col-sm-12">

                    <table class="table table-striped table-bordered table-hover">
                        <thead>
                            <tr>
                                <th style="width:70px;">@StringLocalizer["Id"]</th>
                                <th>@StringLocalizer["Reference"]</th>
                                <th style="width:60px;">@StringLocalizer["Remove"]</th>
                            </tr>
                        </thead>
                        <tbody>
                            @if (Model.ElementRedirect.RelationFields.Count == 0)
                            {
                                <tr>
                                    <td colspan="3">@StringLocalizer["No relationships found"]</td>
                                </tr>
                            }
                            @for (int i = 0; i < Model.ElementRedirect.RelationFields.Count; i++)
                            {
                                <tr>
                                    <td>@i</td>
                                    <td>
                                        @Model.ElementRedirect.RelationFields[i].RedirectField
                                        =
                                        @Model.ElementRedirect.RelationFields[i].InternalField
                                        @Html.HiddenFor(model => model.ElementRedirect.RelationFields[i].InternalField)
                                        @Html.HiddenFor(model => model.ElementRedirect.RelationFields[i].RedirectField)
                                    </td>
                                    <td align="center" valign="middle">
                                        <a href="#" @BootstrapHelper.GetDataToggle("tooltip") title="@StringLocalizer["Remove"]" onclick="removeRelation(@i);">
                                            <span class="fa fa-trash"></span>
                                        </a>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>

                </div>
            </div>
        </div>

        <div id="div-advanced" class="tab-pane fade">
            @await Html.PartialAsync("_NavAdvanced", Model)
        </div>
    </div>

    @await Html.PartialAsync("_Toolbar")
}

