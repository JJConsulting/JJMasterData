@using JJMasterData.Commons.Util
@using System.Text
@using JJMasterData.Core.DataDictionary.Actions.Abstractions
@using JJMasterData.Core.DataDictionary.Actions.UserCreated
@using JJMasterData.Web.Areas.DataDictionary.Models.ViewModels
@using JJMasterData.Core.Web
@using System.Reflection
@inject IStringLocalizer<JJMasterDataResources> StringLocalizer

@model ActionsListDetailsViewModel

@{
    var sortableClass = string.Empty;
}
@if (Model.Actions?.Count > 1)
{
    sortableClass = "jjsortable";
    <script language="javascript" type="text/javascript">
        $(document).ready(function () {
            DataDictionaryUtils.sortAction('@Model.Context.ToString()', '@GetUrlSort()','@StringLocalizer["Unexpected error"]');
        });
    </script>
}

<div class="row mt-3">
    <div class="col-sm-12">
        <div class="btn-group">
            <button type="button" class="@BootstrapHelper.DefaultButton dropdown-toggle" @BootstrapHelper.GetDataToggle("dropdown") aria-haspopup="true" aria-expanded="false">
                <span class="fa fa-plus-circle"></span>&nbsp;@StringLocalizer["New Action"]&nbsp; <span class="caret"></span>
            </button>
            <ul class="dropdown-menu">
                <li><a class="dropdown-item dropdown-link" href="javascript: void(0);" onclick="@GetAddScript(typeof(UrlRedirectAction))">@StringLocalizer["Url Redirect"]</a></li>
                <li><a class="dropdown-item dropdown-link" href="javascript: void(0);" onclick="@GetAddScript(typeof(InternalAction))">@StringLocalizer["Internal Redirect"]</a></li>
                <li><a class="dropdown-item dropdown-link" href="javascript: void(0);" onclick="@GetAddScript(typeof(SqlCommandAction))">@StringLocalizer["Sql Command"]</a></li>
                <li><a class="dropdown-item dropdown-link" href="javascript: void(0);" onclick="@GetAddScript(typeof(ScriptAction))">@StringLocalizer["JavaScript Script"]</a></li>
            </ul>
        </div>
    </div>
</div>
<div class="row">
    <div class="col-sm-12">
        <ul class="list-group @sortableClass" id="sortable_@Model.Context.ToString()">
            @foreach (var action in Model.Actions!)
            {
                <li class="list-group-item" id="@action.Name">
                    <div style="height: 33px;">
                        <div style="float: left; margin-top: 10px;">
                            <span class="@action.Icon.GetCssClass() fa-fw"></span>&nbsp;
                            @action.Name
                            &nbsp;
                        </div>
                        <div class=@BootstrapHelper.PullRight>
                            <button class="@BootstrapHelper.DefaultButton btn-small" type="button" onclick="@GetEditScript(action)">
                                <span class="fa fa-pencil"></span>
                            </button>
                            &nbsp;

                            @if (action.IsUserCreated)
                            {
                                <button class="@BootstrapHelper.DefaultButton btn-small" style="margin-left:14px;" type="button"
                                        onclick="@GetDeleteScript(action)">
                                    <span class="fa fa-trash"></span>
                                </button>
                            }
                            else
                            {
                                <input type="checkbox"
                                       value="btninsert"
                                       @(action.IsVisible ? "checked=\"checked\"" : "")
                                       data-toggle="toggle"
                                       data-size="small"
                                       data-on="On"
                                       data-off="Off"
                                       onchange="DataDictionaryUtils.setDisableAction($(this).prop('checked'),'@GetUrlDisable(action)','@StringLocalizer["Unexpected error"]');">
                            }
                        </div>
                    </div>
                </li>
            }
        </ul>

    </div>
</div>


@functions {

    private string GetEditScript(BasicAction action)
    {
        var script = new StringBuilder();
        script.Append("defaultModal.showIframe('");
        script.Append(Url.Action("Edit", "Actions",
            new { elementName = Model.ElementName, actionName = action.Name, context = Model.Context, fieldName = Model.FieldName }));
        script.Append($"','{Model.Context.ToString().FirstCharToUpper()}");
        script.Append($" Action', {(int)ModalSize.ExtraLarge}");
        script.Append(");");

        return script.ToString();
    }

    private string GetAddScript(MemberInfo actionType)
    {
        var script = new StringBuilder();
        script.Append("defaultModal.showIframe('");
        script.Append(Url.Action("Add", "Actions",
            new { elementName = Model.ElementName, actionName = actionType.Name, context = Model.Context, fieldName = Model.FieldName }));
        script.Append($"','{Model.Context.ToString().FirstCharToUpper()}");
        script.Append($" Action',{(int)ModalSize.ExtraLarge}");
        script.Append(");");

        return script.ToString();
    }

    private string GetDeleteScript(BasicAction action)
    {
        var script = new StringBuilder();
        script.Append("DataDictionaryUtils.deleteAction('");
        script.Append(action.Name);
        script.Append("', '");
        script.Append(Url.Action("Remove", "Actions",
            new { elementName = Model.ElementName, actionName = action.Name, context = Model.Context, fieldName = Model.FieldName }));
        script.Append("', '");
        script.Append(StringLocalizer["Are you sure you want to delete [{0}] action?", action.Name]);
        script.Append("');");

        return script.ToString();
    }

    public string? GetUrlDisable(BasicAction action)
    {
        return Url.Action("EnableDisable", "Actions",
            new { elementName = Model.ElementName, actionName = action.Name, context = Model.Context, fieldName = Model.FieldName });
    }

    public string? GetUrlSort()
    {
        return Url.Action("Sort", "Actions",
            new { elementName = Model.ElementName, fieldName = Model.FieldName });
    }
}